#!/usr/bin/env bash
#
# mango-trace - Helper tool for tracing mango library with bpftrace
#
# Usage:
#   ./mango-trace list <binary>             - List available USDT probes
#   ./mango-trace check <binary>            - Validate USDT support
#   ./mango-trace monitor <binary> [args]   - Quick monitor with preset
#   ./mango-trace run <script> <binary>     - Run specific bpftrace script
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TRACING_DIR="$SCRIPT_DIR/tracing"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    cat << EOF
mango-trace - Helper tool for tracing mango library

Usage:
    mango-trace list <binary>                    List available USDT probes
    mango-trace check <binary>                   Validate USDT support
    mango-trace monitor <binary> [--preset=<p>]  Monitor with preset
    mango-trace run <script> <binary> [args]     Run specific script

Commands:
    list          List all USDT probes in binary
    check         Check if binary has USDT support
    monitor       Quick monitoring (default: monitor_all)
    run           Run a specific bpftrace script

Monitor Presets:
    --preset=all          Monitor all activity (default)
    --preset=convergence  Watch convergence behavior
    --preset=debug        Alert on failures and errors
    --preset=performance  Profile performance and timing
    --preset=pde          PDE solver detailed trace
    --preset=iv           Implied volatility detailed trace

Examples:
    # Check USDT support
    mango-trace check ./bazel-bin/examples/example_heat_equation

    # List available probes
    mango-trace list ./bazel-bin/examples/example_heat_equation

    # Quick monitoring
    mango-trace monitor ./bazel-bin/examples/example_heat_equation

    # Watch convergence
    mango-trace monitor ./bazel-bin/examples/example_heat_equation --preset=convergence

    # Run specific script
    mango-trace run convergence_watch.bt ./bazel-bin/examples/example_heat_equation

    # Monitor with binary arguments
    mango-trace monitor ./my_program --preset=debug -- --my-arg value

Requirements:
    - bpftrace (v0.12+)
    - Root privileges (sudo)
    - Binary built with USDT support

EOF
}

check_requirements() {
    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}Error: This tool requires root privileges${NC}"
        echo "Please run with sudo:"
        echo "  sudo $0 $@"
        exit 1
    fi

    # Check if bpftrace is installed
    if ! command -v bpftrace &> /dev/null; then
        echo -e "${RED}Error: bpftrace is not installed${NC}"
        echo "Install it with:"
        echo "  Debian/Ubuntu: sudo apt-get install bpftrace"
        echo "  RHEL/Fedora:   sudo yum install bpftrace"
        exit 1
    fi

    # Check bpftrace version
    local version=$(bpftrace --version 2>&1 | grep -oP 'version \K[0-9.]+' || echo "0.0")
    local major=$(echo "$version" | cut -d. -f1)
    local minor=$(echo "$version" | cut -d. -f2)

    if [[ $major -eq 0 && $minor -lt 12 ]]; then
        echo -e "${YELLOW}Warning: bpftrace version $version detected${NC}"
        echo "Version 0.12+ recommended for best compatibility"
    fi
}

list_probes() {
    local binary="$1"

    if [[ ! -f "$binary" ]]; then
        echo -e "${RED}Error: Binary not found: $binary${NC}"
        exit 1
    fi

    echo -e "${BLUE}USDT probes in $binary:${NC}"
    echo

    if ! bpftrace -l "usdt:$binary:mango:*" 2>/dev/null; then
        echo -e "${RED}No USDT probes found!${NC}"
        echo "This binary may not have been built with USDT support."
        echo "Verify with: readelf -n $binary | grep NT_STAPSDT"
        exit 1
    fi
}

check_usdt() {
    local binary="$1"

    if [[ ! -f "$binary" ]]; then
        echo -e "${RED}Error: Binary not found: $binary${NC}"
        exit 1
    fi

    echo -e "${BLUE}Checking USDT support in $binary...${NC}"
    echo

    # Check for USDT notes in ELF
    if readelf -n "$binary" 2>/dev/null | grep -q NT_STAPSDT; then
        echo -e "${GREEN}✓ USDT notes found in binary${NC}"

        # Count probes
        local probe_count=$(bpftrace -l "usdt:$binary:mango:*" 2>/dev/null | wc -l)
        echo -e "${GREEN}✓ Found $probe_count mango probes${NC}"

        # Check bpftrace can see them
        if bpftrace -l "usdt:$binary:mango:*" &>/dev/null; then
            echo -e "${GREEN}✓ bpftrace can attach to probes${NC}"
        else
            echo -e "${YELLOW}⚠ bpftrace cannot list probes (may need newer version)${NC}"
        fi

        echo
        echo -e "${GREEN}USDT support: OK${NC}"
        echo "You can trace this binary with bpftrace scripts."

    else
        echo -e "${RED}✗ No USDT notes found in binary${NC}"
        echo
        echo "This binary was likely not built with -DHAVE_SYSTEMTAP_SDT"
        echo "or systemtap-sdt-dev is not installed."
        echo
        echo "To fix:"
        echo "  1. Install systemtap-sdt-dev:"
        echo "     Debian/Ubuntu: sudo apt-get install systemtap-sdt-dev"
        echo "  2. Rebuild the binary"
        exit 1
    fi
}

monitor() {
    local binary=""
    local preset="all"
    local binary_args=()

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --preset=*)
                preset="${1#*=}"
                shift
                ;;
            --)
                shift
                binary_args=("$@")
                break
                ;;
            *)
                if [[ -z "$binary" ]]; then
                    binary="$1"
                else
                    binary_args+=("$1")
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$binary" ]]; then
        echo -e "${RED}Error: No binary specified${NC}"
        usage
        exit 1
    fi

    if [[ ! -f "$binary" ]]; then
        echo -e "${RED}Error: Binary not found: $binary${NC}"
        exit 1
    fi

    # Select script based on preset
    local script=""
    case $preset in
        all)
            script="$TRACING_DIR/monitor_all.bt"
            ;;
        convergence)
            script="$TRACING_DIR/convergence_watch.bt"
            ;;
        debug)
            script="$TRACING_DIR/debug_failures.bt"
            ;;
        performance)
            script="$TRACING_DIR/performance_profile.bt"
            ;;
        pde)
            script="$TRACING_DIR/pde_detailed.bt"
            ;;
        iv)
            script="$TRACING_DIR/iv_detailed.bt"
            ;;
        *)
            echo -e "${RED}Error: Unknown preset: $preset${NC}"
            echo "Available presets: all, convergence, debug, performance, pde, iv"
            exit 1
            ;;
    esac

    if [[ ! -f "$script" ]]; then
        echo -e "${RED}Error: Script not found: $script${NC}"
        exit 1
    fi

    echo -e "${BLUE}Starting trace with preset '$preset'...${NC}"
    echo "Binary: $binary ${binary_args[*]}"
    echo "Script: $script"
    echo

    # Run bpftrace
    if [[ ${#binary_args[@]} -gt 0 ]]; then
        exec bpftrace "$script" -c "$binary ${binary_args[*]}"
    else
        exec bpftrace "$script" -c "$binary"
    fi
}

run_script() {
    local script="$1"
    local binary="$2"
    shift 2
    local binary_args=("$@")

    if [[ -z "$script" ]] || [[ -z "$binary" ]]; then
        echo -e "${RED}Error: Script and binary required${NC}"
        usage
        exit 1
    fi

    # Find script
    local script_path=""
    if [[ -f "$script" ]]; then
        script_path="$script"
    elif [[ -f "$TRACING_DIR/$script" ]]; then
        script_path="$TRACING_DIR/$script"
    else
        echo -e "${RED}Error: Script not found: $script${NC}"
        echo "Looked in:"
        echo "  - $script"
        echo "  - $TRACING_DIR/$script"
        exit 1
    fi

    if [[ ! -f "$binary" ]]; then
        echo -e "${RED}Error: Binary not found: $binary${NC}"
        exit 1
    fi

    echo -e "${BLUE}Running trace script...${NC}"
    echo "Script: $script_path"
    echo "Binary: $binary ${binary_args[*]}"
    echo

    # Run bpftrace
    if [[ ${#binary_args[@]} -gt 0 ]]; then
        exec bpftrace "$script_path" -c "$binary ${binary_args[*]}"
    else
        exec bpftrace "$script_path" -c "$binary"
    fi
}

# Main command dispatcher
case "${1:-}" in
    list)
        check_requirements "$@"
        list_probes "$2"
        ;;
    check)
        check_requirements "$@"
        check_usdt "$2"
        ;;
    monitor)
        check_requirements "$@"
        shift
        monitor "$@"
        ;;
    run)
        check_requirements "$@"
        shift
        run_script "$@"
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        echo -e "${RED}Error: Unknown command: ${1:-}${NC}"
        echo
        usage
        exit 1
        ;;
esac
